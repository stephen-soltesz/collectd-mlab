"""Tests for models."""

import StringIO
import unittest

import models


class LoadSwitchConfigTest(unittest.TestCase):

    def test_load_switch_config_load_and_get_model_successfully(self):
        config_fd = StringIO.StringIO("""
!config
models:
    - !model
      name: procurve
      pattern: ProCurve
      oids:
          discards:
              !oid
              rx: abc
              tx: def

default_oids:
    octets:
        !oid
        rx: ghi
        tx: jkl
""")

        config = models.load_switch_config(config_fd)
        model = config.get_model('Fake ProCurve sysDescr message')

        # Check config.
        self.assertEqual(1, len(config.models))
        self.assertEqual('procurve', config.models[0].name)
        self.assertEqual('ProCurve', config.models[0].pattern)
        self.assertEqual(1, len(config.default_oids))
        self.assertEqual('ghi', config.default_oids['octets'].rx)
        self.assertEqual('jkl', config.default_oids['octets'].tx)
        # Check model.
        self.assertEqual(2, len(model.oids))
        self.assertEqual('abc', model.oids['discards'].rx)
        self.assertEqual('def', model.oids['discards'].tx)
        self.assertEqual('ghi', model.oids['octets'].rx)
        self.assertEqual('jkl', model.oids['octets'].tx)

    def test_load_switch_config_raises_BadConfiguration_when_config_misaligned(
            self):
        config_fd = StringIO.StringIO("""
!config
models:
    - !model
      name: procurve
     pattern: <--MISALIGNED

default_oids:
    discards:
        !oid
        rx: abc
        tx: def
""")
        with self.assertRaises(models.BadConfiguration):
            models.load_switch_config(config_fd)


class ConfigTest(unittest.TestCase):

    def test_init_raises_BadConfiguration_when_parmaters_not_given(self):
        with self.assertRaises(models.BadConfiguration):
            models.Config(models=None, default_oids=None, line='none')

    def test_get_model_raises_UnknownSwitchModel_when_no_patterns_match(self):
        model = models.Model(name='ok', pattern='foo', oids={})
        config = models.Config(models=(model,), default_oids={})

        with self.assertRaises(models.UnknownSwitchModel):
            config.get_model('sysDescr value that does not contain pattern')


class ModelTest(unittest.TestCase):

    def test_init_raises_BadConfiguration_when_parameters_not_given(self):
        with self.assertRaises(models.BadConfiguration):
            models.Model(name=None, line='none')

    def test_oid_names(self):
        oids = {
            'octets': models.OID(rx='abc',
                                 tx='def'),
            'discards': models.OID(rx='ghi',
                                   tx='jkl'),
        }
        model = models.Model(name='ok', pattern='foo', oids=oids)

        actual = model.oid_names()

        self.assertItemsEqual(['octets', 'discards'], actual)

    def test_lookup_oids(self):
        oids = {'octets': models.OID(rx='abc.{ifIndex}', tx='def.{ifIndex}'),}
        model = models.Model(name='ok', pattern='foo', oids=oids)

        actual = model.lookup_oids('octets', '10')

        self.assertItemsEqual(('abc.10', 'def.10'), actual)

    def test_lookup_oids_raises_UnknownOidName_when_oid_name_not_present(self):
        model = models.Model(name='ok', pattern='foo', oids={})

        with self.assertRaises(models.UnknownOidName):
            model.lookup_oids('missing-oid-name', '10')


class OIDTest(unittest.TestCase):

    def test_init_raises_BadConfiguration_when_parameters_not_given(self):
        with self.assertRaises(models.BadConfiguration):
            models.OID(rx=None, line='none')


if __name__ == '__main__':
    unittest.main()
